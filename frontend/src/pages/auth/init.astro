---
import NoAuthLayout from "@/layouts/NoAuthLayout.astro";
---

<NoAuthLayout head={{ title: "Initialize ABR" }}>
    <div class="h-screen w-full flex flex-col items-center justify-center">
        <div id="loading" class="flex flex-col items-center gap-4">
            <span class="loading loading-spinner loading-lg"></span>
            <p>Loading...</p>
        </div>
        <div id="error-container" class="hidden">
            <p id="error-message" class="text-error"></p>
        </div>
        <form class="hidden flex-col gap-2 w-80 sm:w-120 mb-2" id="init-form">
            <p class="opacity-60">
                No user was found in the database. Please create a root admin
                user to get set up. OpenID Connect can be configured later.
            </p>
            <label for="login-type">Login Type</label>
            <select id="login-type" name="login_type" class="select w-full">
                <option value="basic">Basic Auth (Dialog)</option>
                <option value="forms" selected>Forms Login</option>
                <option value="none">None (Insecure)</option>
            </select>
            <p id="forced-login-notice" class="text-xs opacity-60 hidden">
                Login type is forced by the environment variable
                <code>ABR_APP__FORCE_LOGIN_TYPE</code>.
            </p>

            <label for="username">Username</label>
            <input
                name="username"
                type="text"
                class="input w-full"
                minlength="1"
                required
            />
            <label for="password">Password</label>
            <input
                name="password"
                type="password"
                class="input w-full"
                required
            />
            <label for="confirm_password">Confirm password</label>
            <input
                name="confirm_password"
                type="password"
                class="input w-full"
                required
            />

            <button id="init-submit" class="btn btn-primary" type="submit">
                Create account
            </button>
        </form>
        <p id="form-error" class="text-error hidden h-0"></p>
    </div>
</NoAuthLayout>

<script>
    import type { LoginTypeEnum } from "@/client";
    import { initRootUser } from "@/lib/auth-client";
    import { getLoginTypeApiAuthTypeGet } from "@/client";
    import { client } from "@/lib/client";

    (async () => {
        const form = document.getElementById(
            "init-form",
        ) as HTMLFormElement | null;
        const error = document.getElementById("form-error");
        const submit = document.getElementById(
            "init-submit",
        ) as HTMLButtonElement | null;
        const loading = document.getElementById("loading");
        const errorContainer = document.getElementById("error-container");
        const errorMessage = document.getElementById("error-message");
        const loginTypeSelect = document.getElementById(
            "login-type",
        ) as HTMLSelectElement | null;
        const forcedLoginNotice = document.getElementById(
            "forced-login-notice",
        );

        if (
            !form ||
            !error ||
            !submit ||
            !loading ||
            !errorContainer ||
            !errorMessage ||
            !loginTypeSelect ||
            !forcedLoginNotice
        ) {
            console.error("Element not found", {
                form,
                error,
                submit,
                loading,
                errorContainer,
                errorMessage,
                loginTypeSelect,
                forcedLoginNotice,
            });
            return;
        }

        // Check if init is needed
        const { data: loginTypeData, error: loginTypeError } =
            await getLoginTypeApiAuthTypeGet({ client });

        if (loginTypeError) {
            loading.classList.add("hidden");
            errorContainer.classList.remove("hidden");
            const detail = (loginTypeError as any)?.detail;
            errorMessage.innerText =
                "Failed to access the backend API: " +
                (detail ? String(detail) : "Unknown error");
            return;
        }

        // If login type is already set, redirect to home
        if (loginTypeData?.login_type !== "not_set") {
            window.location.href = "/";
            return;
        }

        // Show the form
        loading.classList.add("hidden");
        form.classList.remove("hidden");
        form.classList.add("flex");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            error.innerText = "";
            error.classList.add("hidden");
            submit.disabled = true;

            const username = form.elements.namedItem(
                "username",
            ) as HTMLInputElement | null;
            const password = form.elements.namedItem(
                "password",
            ) as HTMLInputElement | null;
            const confirmPassword = form.elements.namedItem(
                "confirm_password",
            ) as HTMLInputElement | null;
            const loginType = form.elements.namedItem(
                "login_type",
            ) as HTMLSelectElement | null;

            if (!username || !password || !confirmPassword || !loginType) {
                console.error("Form element not found", {
                    username,
                    password,
                    confirmPassword,
                    loginType,
                });

                error.innerText =
                    "Internal error: Form element not found. Please try again or get support on Github or on the Discord.";
                error.classList.remove("hidden");
                submit.disabled = false;
                return;
            }

            let loginTypeValue: LoginTypeEnum | null = null;
            if (
                loginType.value === "basic" ||
                loginType.value === "forms" ||
                loginType.value === "none"
            ) {
                loginTypeValue = loginType.value;
            } else {
                console.warn("Invalid login type selected", {
                    value: loginType.value,
                });
                error.innerText =
                    "Invalid login type selected. Please select a valid login type.";
                error.classList.remove("hidden");
                submit.disabled = false;
                return;
            }

            const errorMessage = await initRootUser({
                loginType: loginTypeValue,
                username: username.value,
                password: password.value,
            });

            if (errorMessage) {
                error.innerText = errorMessage;
                error.classList.remove("hidden");
                submit.disabled = false;
            } else {
                window.location.href = "/";
            }
        });
    })();
</script>
