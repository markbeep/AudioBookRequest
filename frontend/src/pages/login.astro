---
import NoAuthLayout from "@/layouts/NoAuthLayout.astro";
---

<NoAuthLayout head={{ title: "Login" }}>
    <div class="h-screen w-full flex flex-col items-center justify-center">
        <h1 class="text-4xl font-bold mb-8">AudioBookRequest</h1>
        <div id="loading" class="flex flex-col items-center gap-4">
            <span class="loading loading-spinner loading-lg"></span>
            <p>Loading...</p>
        </div>
        <div id="error-container" class="hidden">
            <p id="error-message" class="text-error"></p>
        </div>
        <form
            id="login-form"
            class="hidden flex-col gap-2 w-80 sm:w-120 px-4 mb-2"
        >
            <div id="backup-notice" class="hidden">
                <h1 class="text-xl">Backup Login</h1>
                <p class="text-error">
                    This instance has OIDC enabled. This login can only be used
                    by the root admin.
                </p>
            </div>
            <h1 id="login-title" class="text-xl">Login</h1>
            <label for="username">Username</label>
            <input name="username" type="text" class="input w-full" required />
            <label for="password">Password</label>
            <input
                name="password"
                type="password"
                class="input w-full"
                required
            />
            <button id="login-submit" class="btn btn-primary" type="submit">
                Login
            </button>
        </form>
        <p id="form-error" class="text-error hidden h-0"></p>
    </div>
</NoAuthLayout>

<script>
    import {
        getLoginTypeAuthTypeGet,
        loginAccessTokenAuthTokenPost,
    } from "@/client";

    const form = document.getElementById(
        "login-form",
    ) as HTMLFormElement | null;
    const error = document.getElementById("form-error");
    const submit = document.getElementById(
        "login-submit",
    ) as HTMLButtonElement | null;
    const loading = document.getElementById("loading");
    const errorContainer = document.getElementById("error-container");
    const errorMessage = document.getElementById("error-message");
    const backupNotice = document.getElementById("backup-notice");
    const loginTitle = document.getElementById("login-title");

    (async () => {
        if (
            !form ||
            !error ||
            !submit ||
            !loading ||
            !errorContainer ||
            !errorMessage ||
            !backupNotice ||
            !loginTitle
        ) {
            console.error("Element not found", {
                form,
                error,
                submit,
                loading,
                errorContainer,
                errorMessage,
                backupNotice,
                loginTitle,
            });
            return;
        }

        // Get URL parameters
        const url = new URL(window.location.href);
        const backup = ["1", "true"].includes(
            url.searchParams.get("backup")?.toLowerCase() ?? "0",
        );
        const redirectUri = url.searchParams.get("redirect_uri") ?? "/";

        // Check login type
        const { data: loginTypeData, error: loginTypeError } =
            await getLoginTypeAuthTypeGet();

        if (loginTypeError) {
            loading.classList.add("hidden");
            errorContainer.classList.remove("hidden");
            const detail = (loginTypeError as any)?.detail;
            errorMessage.innerText =
                "Failed to access the backend API: " +
                (detail ? String(detail) : "Unknown error");
            return;
        }

        const loginType = loginTypeData?.login_type;

        // Handle different login types
        if (loginType === "not_set") {
            window.location.href = "/init";
            return;
        }

        if (loginType === "basic" || loginType === "none") {
            window.location.href = redirectUri;
            return;
        }

        if (loginType === "oidc" && !backup) {
            window.location.href = `/auth/login?redirect_uri=${encodeURIComponent(redirectUri)}`;
            return;
        }

        // Show the form for forms login or backup OIDC login
        loading.classList.add("hidden");
        form.classList.remove("hidden");
        form.classList.add("flex");

        if (backup && loginType === "oidc") {
            backupNotice.classList.remove("hidden");
            loginTitle.classList.add("hidden");
        }

        // Handle form submission
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            error.innerText = "";
            error.classList.add("hidden");
            submit.disabled = true;

            const username = form.elements.namedItem(
                "username",
            ) as HTMLInputElement | null;
            const password = form.elements.namedItem(
                "password",
            ) as HTMLInputElement | null;

            if (!username || !password) {
                console.error("Form element not found", {
                    username,
                    password,
                });

                error.innerText =
                    "Internal error: Form element not found. This is an AudioBookRequest issue.";
                error.classList.remove("hidden");
                submit.disabled = false;
                return;
            }

            const { error: errorObj } = await loginAccessTokenAuthTokenPost({
                body: {
                    username: username.value,
                    password: password.value,
                },
            });

            if (errorObj) {
                const errorMessage =
                    errorObj instanceof Error
                        ? errorObj.message
                        : JSON.stringify(errorObj);
                error.innerText = errorMessage;
                error.classList.remove("hidden");
                submit.disabled = false;
            } else {
                window.location.href = redirectUri;
            }
        });
    })();
</script>
