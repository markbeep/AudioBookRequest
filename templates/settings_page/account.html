{% extends "settings_page/base.html" %}
{% block head %}
  <title>Settings - Account</title>
{% endblock head %}
{% block content %}
  <div class="flex flex-col gap-6">
    <form id="change-password-form"
          class="flex flex-col gap-2"
          hx-post="{{ base_url }}/settings/account/password"
          hx-target="this">
      {% if success %}<script>toast("{{success|safe}}", "success");</script>{% endif %}
      <h2 class="text-lg">Change Password</h2>
      <label for="old-password">Old password</label>
      <input id="old-password"
             name="old_password"
             type="password"
             class="input w-full"
             required />
      <label for="change-password-1">New Password</label>
      <input id="change-password-1"
             name="password"
             type="password"
             class="input w-full"
             required />
      <label for="change-password-2">Confirm password</label>
      <input id="change-password-2"
             name="confirm_password"
             type="password"
             class="input w-full"
             required />
      <button name="submit" class="btn btn-primary" type="submit">Change password</button>
    </form>
    <hr class="w-48 h-1 mx-auto my-4 bg-gray-100 border-0 rounded-sm md:my-10 dark:bg-gray-700">

    {% block api_keys %}
    <div id="api_keys">
      <h2 class="text-lg mb-2">API Keys</h2>
      <p class="text-sm text-gray-600 mb-4">
        API keys allow external applications to access your account.
      </p>
      
      <form id="create-api-key-form"
            class="flex flex-col gap-2 mb-4"
            hx-post="{{ base_url }}/settings/account/api-key"
            hx-target="#api_keys">
        <div class="flex gap-2">
          <input name="name"
                 type="text"
                 placeholder="API Key Name"
                 class="input w-full"
                 required />
          <button type="submit" class="btn btn-primary">Create API Key</button>
        </div>
      </form>

      {% if show_api_key %}
      <div class="card mb-4 shadow-sm dark:border dark:border-gray-700">
        <div class="flex flex-col card-body gap-2">
          <p><strong>Your new API key:</strong></p>
          <div class="flex gap-2">
            <code class="bg-base-200 p-2 rounded flex-1">{{ new_api_key }}</code>
            <div class="relative">
              <button id="copy-button" onclick="copyAPIKey()" class="btn text-xs transition-all duration-500 min-w-20">
                Copy
                <script>
                  let beingCopied = false;
                  function copyAPIKey() {
                    if (beingCopied) return;
                    beingCopied = true;
                    navigator.clipboard.writeText('{{ new_api_key }}');
                    const copiedText = document.getElementById('copy-button');
                    copiedText.classList.add('btn-success');
                    copiedText.textContent = 'Copied!';
                    setTimeout(() => { 
                      copiedText.classList.remove('btn-success');
                      copiedText.textContent = 'Copy';
                      beingCopied = false;
                    }, 2000);
                  }
                </script>
              </button>
            </div>
          </div>
          <p class="text-sm text-error">
            <strong>Important:</strong> This is the only time you'll see this key. Store it securely!
          </p>
        </div>
      </div>
      {% endif %}

      {% if api_keys %}
        <div class="overflow-x-auto">
          <table class="table w-full">
            <thead>
              <tr>
                <th>Name</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for api_key in api_keys %}
                <tr>
                  <td>{{ api_key.name }}</td>
                  <td>{{ api_key.created_at.strftime('%Y-%m-%d %H:%M') }} GMT</td>
                  <td>
                    {% if api_key.last_used %}
                      {{ api_key.last_used.strftime('%Y-%m-%d %H:%M') }} GMT
                    {% else %}
                      Never
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge {% if api_key.enabled %}badge-success{% else %}badge-error{% endif %}">
                      {% if api_key.enabled %}Enabled{% else %}Disabled{% endif %}
                    </span>
                  </td>
                  <td>
                    <div class="flex gap-2">
                      <button hx-patch="{{ base_url }}/settings/account/api-key/{{ api_key.id }}/toggle"
                              hx-target="#api_keys"
                              class="btn btn-sm">
                        {% if api_key.enabled %}Disable{% else %}Enable{% endif %}
                      </button>
                      <button onclick="delete_api_key_modal_{{ loop.index }}.showModal()"
                              class="btn btn-sm btn-error">Delete</button>
                      <dialog id="delete_api_key_modal_{{ loop.index }}" class="modal">
                        <div class="modal-box">
                          <h3 class="text-lg font-bold">Are you sure you want to delete this API key?</h3>
                          <div class="grid grid-cols-2 py-4">
                            <span class="font-semibold mr-2">Name</span><span class="font-mono">{{ api_key.name }}</span>
                            <span class="font-semibold mr-2">Created</span><span class="font-mono">{{ api_key.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            <span class="font-semibold mr-2">Last Used</span>
                            <span class="font-mono">
                              {% if api_key.last_used %}
                                {{ api_key.last_used.strftime('%Y-%m-%d %H:%M') }} GMT
                              {% else %}
                                Never
                              {% endif %}
                            </span>
                          </div>
                          <form method="dialog" class="flex justify-between">
                            <button class="btn">Cancel</button>
                            <button class="btn bg-error"
                                    hx-delete="{{ base_url }}/settings/account/api-key/{{ api_key.id }}"
                                    hx-disabled-elt="this"
                                    hx-target="#api_keys">Delete</button>
                          </form>
                        </div>
                        <form method="dialog" class="modal-backdrop">
                          <button>close</button>
                        </form>
                      </dialog>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-gray-600">No API keys created yet.</p>
      {% endif %}
    </div>
    {% endblock api_keys %}
  </div>
{% endblock content %}
