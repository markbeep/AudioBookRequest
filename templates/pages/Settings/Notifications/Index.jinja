{#def
    user: DetailedUser,
    notifications: Sequence[Notification],
    event_types: list[str],
    body_types: list[str],
#}

<SettingsLayout user={{ user }} page="notifications" title="Settings - Notifications">
<js.AlpineJS />

<div class="flex flex-col">
    <h2 class="text-lg">
        Notifications
    </h2>
    <form id="add-notification-form"
          class="flex flex-col gap-2"
          hx-post="{{ base_url }}/settings/notifications/hx-add"
          hx-target="#notification-list"
          hx-swap="outerHTML"
          hx-on::after-request="if (event.detail.successful && event.detail.target?.id === 'notification-list') this.reset()"
          x-data="{ body_type: '{{ body_types[0] }}' }">
        <label for="name">
            Name<span class="text-error">*</span>
        </label>
        <input id="name"
               name="name"
               minlength="1"
               type="text"
               class="input w-full"
               required />
        <label for="event">
            Event<span class="text-error">*</span>
        </label>
        <select id="event" name="event_type" class="select w-full" required>
            {% for e in event_types %}
                <option value="{{ e }}">
                    {{ e }}
                </option>
            {% endfor %}
        </select>
        <label for="url" class="flex gap-0 flex-col">
            <span>Notification URL<span class="text-error">*</span></span>
            <br />
            <span class="text-xs font-mono">(http://.../notify/c2h3fg...)</span>
        </label>
        <input id="url"
               name="url"
               minlength="1"
               type="text"
               class="input w-full"
               required />
        <label for="body_type">
            Body Type<span class="text-error">*</span>
        </label>
        <select id="body_type"
                name="body_type"
                class="select w-full"
                required
                x-model="body_type">
            {% for e in body_types %}
                <option value="{{ e }}" {% if loop.index.__eq__(0) %}selected{% endif %}>
                    {{ e }}
                </option>
            {% endfor %}
        </select>
        <label for="body">
            Body<span class="text-error">*</span>
            <template x-if="body_type === 'json'">
                <span class="text-xs text-error">(JSON format)</span>
            </template>
        </label>
        <textarea id="body"
                  required
                  name="body"
                  type="text"
                  class="textarea w-full"
                  :class="{ 'font-mono': body_type === 'json' }"
                  placeholder="{&quot;{eventType}&quot;: {&quot;book&quot;: &quot;{bookTitle}&quot;}}"></textarea>
        <label for="headers">
            Headers
            <span class="text-xs">(JSON format, optional)</span>
        </label>
        <input id="headers"
               name="headers"
               type="text"
               class="input w-full font-mono"
               placeholder="{&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;password123&quot;}"
               pattern="{{ json_regexp }}" />
        <p class="flex flex-col text-xs opacity-60">
            Possible event variables:
            <span class="font-mono">
                eventType, eventUser, eventUserExtraData, bookTitle, bookAuthors, bookCover, bookNarrators, bookASIN, torrentInfoHash,
                sourceSizeMB, sourceTitle, indexerName, sourceProtocol
            </span>
            <span class="mt-1">Failed download event additionally has:</span>
            <span class="font-mono">errorStatus, errorReason</span>
        </p>
        <button type="submit" class="btn">
            Add
        </button>
    </form>
</div>

<Settings.Notifications.List notifications={{ notifications }} event_types={{ event_types }} body_types={{ body_types }} />

</SettingsLayout>
