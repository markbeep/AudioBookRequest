{% extends "base.html" %}
{% block head %}
  <title>Sources</title>
{% endblock head %}
{% block body %}
  <div class="app-shell" id="sources">
    <div class="app-content app-stack">
      <div class="flex items-center justify-between mb-8">
          <div>
              <h1 class="text-4xl font-black">Sources</h1>
              <p class="text-sm opacity-60 mt-1">Available downloads for {{ result.book.title }}</p>
          </div>
          <a preload
             href="{{ base_url }}/wishlist#{{ result.book.asin }}"
             class="btn btn-ghost bg-base-200 btn-sm rounded-xl font-black uppercase text-[10px] tracking-wider px-4">‚Üê Back to Wishlist</a>
      </div>
      
      {% if result.state.ok and not result.sources %}
        <div role="alert" class="alert bg-base-200 border-base-300 rounded-2xl p-6">
          <span class="stroke-info h-6 w-6 shrink-0">{% include "icons/info-circle.html" %}</span>
          <span class="font-bold">No results found for "{{ result.book.title }}". Might have to be looked up manually.</span>
        </div>
      {% elif not result.ok %}
        <div role="alert"
             class="alert bg-primary/10 border-primary/20 text-primary rounded-2xl p-6"
             hx-get="{{ base_url }}/wishlist/sources/{{ result.book.asin }}?only_body=true"
             hx-trigger="load"
             hx-target="#sources"
             hx-swap="outerHTML">
          <span class="loading loading-dots"></span>
          <span class="font-black uppercase tracking-widest text-xs">Fetching sources from prowlarr...</span>
        </div>
      {% endif %}

      {% if result.sources %}
      <div class="flex flex-col gap-2 app-stagger">
        {% for source in (result.sources or []) %}
          <div class="bg-base-100 rounded-xl border border-base-300 p-4 flex flex-col md:flex-row items-center justify-between gap-6 hover:border-primary transition-all group {% if loop.index==1 %}ring-2 ring-success/30 border-success{% endif %}">
            
            <!-- Left: Main Info -->
            <div class="flex-1 min-w-0 w-full">
              <div class="flex items-center gap-3 mb-1">
                  {% if source.protocol == "torrent" %}
                  <span class="badge badge-xs bg-success/10 text-success border-success/20 font-black uppercase text-[8px] tracking-widest px-2 py-2">Torrent</span>
                  {% else %}
                  <span class="badge badge-xs bg-info/10 text-info border-info/20 font-black uppercase text-[8px] tracking-widest px-2 py-2">Usenet</span>
                  {% endif %}
                  <span class="font-mono text-[10px] opacity-40 uppercase">{{ source.indexer }}</span>
              </div>
              
              {% if source.info_url %}
                <a href="{{ source.info_url }}" class="font-black text-sm hover:text-primary transition-colors line-clamp-1" target="_blank">
                  {{ source.title }}
                </a>
              {% else %}
                <span class="font-black text-sm line-clamp-1">{{ source.title }}</span>
              {% endif %}

              <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2">
                  {% if source.book_metadata.authors %}
                  <div class="flex items-center gap-1.5">
                      <span class="text-[9px] font-black uppercase tracking-widest opacity-30">Author</span>
                      <span class="text-[10px] font-bold opacity-60">{{ source.book_metadata.authors|join(", ") }}</span>
                  </div>
                  {% endif %}
                  <div class="flex items-center gap-1.5">
                      <span class="text-[9px] font-black uppercase tracking-widest opacity-30">Size</span>
                      <span class="text-[10px] font-bold opacity-60">{{ source.size_MB }} MB</span>
                  </div>
                  <div class="flex items-center gap-1.5">
                      <span class="text-[9px] font-black uppercase tracking-widest opacity-30">Date</span>
                      <span class="text-[10px] font-bold opacity-60">{{ source.publish_date.strftime("%d %b %Y") }}</span>
                  </div>
              </div>
            </div>

            <!-- Right: Stats & Action -->
            <div class="flex items-center gap-8 shrink-0">
              <div class="flex gap-6">
                  {% if source.protocol == "torrent" %}
                  <div class="flex flex-col items-center">
                    <span class="text-[9px] font-black uppercase tracking-widest opacity-30">Seeds</span>
                    <span class="font-black text-success text-sm">{{ source.seeders }}</span>
                  </div>
                  {% else %}
                  <div class="flex flex-col items-center">
                    <span class="text-[9px] font-black uppercase tracking-widest opacity-30">Grabs</span>
                    <span class="font-black text-info text-sm">{{ source.grabs }}</span>
                  </div>
                  {% endif %}
              </div>

              <div class="h-10 w-px bg-base-300"></div>

              <label id="form-{{ loop.index }}" class="swap cursor-pointer" title="Send to download client">
                <input id="checkbox-{{ loop.index }}"
                       type="checkbox"
                       hx-trigger="click"
                       hx-target="this"
                       hx-post="{{ base_url }}/wishlist/sources/{{ result.book.asin }}"
                       hx-include="#form-{{ loop.index }}"
                       hx-on::after-request="if (event.detail.successful) this.disabled = true" />
                <input type="hidden" name="indexer_id" value="{{ source.indexer_id }}" />
                <input type="hidden" name="guid" value="{{ source.guid }}" />
                
                <span class="swap-off btn btn-sm btn-primary rounded-xl font-black uppercase text-[10px] tracking-widest px-6 h-10 min-h-0">
                  <span class="size-3.5">{% include "icons/download.html" %}</span>
                  Get
                </span>
                <span class="swap-on btn btn-sm btn-success rounded-xl font-black uppercase text-[10px] tracking-widest px-6 h-10 min-h-0">
                  <span class="size-3.5">{% include "icons/checkmark.html" %}</span>
                  Sent
                </span>
              </label>
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
{% endblock body %}
