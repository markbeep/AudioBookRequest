{% extends "base.html" %}
{% block head %}
  <title>Search</title>
  <script src="{{ base_url }}/static/search.js?v={{ version }}"></script>
{% endblock head %}
{% block body %}
  <div class="app-shell">
    <div class="app-content app-stack">
      <div class="flex w-full justify-between items-center mb-8 gap-4">
        <div>
          <h1 class="text-4xl font-bold text-left">Search</h1>
          <p class="text-sm opacity-70 mt-1">Find audiobooks from Audible or add manually</p>
        </div>
        <a preload
           href="{{ base_url }}/search/manual"
           title="Manually add request"
           class="btn btn-primary btn-sm rounded-lg gap-2 flex items-center justify-center whitespace-nowrap">
          Manual Add
          {% include "icons/plus.html" %}
        </a>
      </div>

      <div class="flex flex-col gap-8 justify-start items-center w-full mb-12">
        <form class="flex items-center w-full max-w-3xl gap-2 app-card app-panel" onsubmit="onSearch();">
          <input name="q"
                 class="input focus:z-10 flex-1"
                 placeholder="Search by title, author, or narrator..."
                 {% if not search_term %}autofocus{% endif %}
                 value="{{ search_term }}"
                 spellcheck="false"
                 autocomplete="off"
                 list="search-suggestions"
                 hx-get="{{ base_url }}/search/suggestions?region={{ selected_region }}"
                 hx-target="#search-suggestions"
                 hx-swap="outerHTML"
                 hx-trigger="keyup changed delay:250ms" />
          {% block search_suggestions %}
            <datalist id="search-suggestions">
              {% for suggestion in (suggestions or [])[:3] %}<option value="{{ suggestion }}"></option>{% endfor %}
            </datalist>
          {% endblock search_suggestions %}
          <select class="select select-sm focus:z-10 max-w-24" name="region">
            {% for region in regions.keys() %}
              <option value="{{ region }}"
                      {% if region.__eq__(selected_region) %}selected="selected"{% endif %}>{{ region }}</option>
            {% endfor %}
          </select>
          <button id="search" class="btn btn-primary btn-sm" type="submit">
            <span id="search-text">Search</span>
            <span id="search-spinner" class="loading hidden"></span>
          </button>
        </form>

      {% block book_results %}
        <div id="book-results"
             class="w-full grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 pb-12 app-stagger">
          {% for result in search_results %}
            {% set book = result.book %}
            {% set already_requested = result.already_requested %}
            {% include "components/book_card.html" %}
          {% endfor %}
        </div>
      {% endblock book_results %}

      {% if search_results or page > 0 %}
        <div class="flex justify-center mt-8">
            <div class="join">
              <button class="join-item btn"
                      onclick="onPageChange('{{ page-1 }}')"
                      {% if page.__eq__(0) %}disabled{% endif %}>«</button>
              <button class="join-item btn flex flex-col gap-0"
                      onclick="onPageChange('{{ 0 }}')"
                      {% if page.__eq__(0) %}disabled{% endif %}>
                Page {{ page+1 }}
                <span class="text-[0.5rem]">back to first</span>
              </button>
              <button class="join-item btn" onclick="onPageChange('{{ page+1 }}')">»</button>
            </div>
        </div>
      {% endif %}

      {% if not search_results %}
        <div class="pt-8 flex flex-col gap-1 items-center justify-center text-center max-w-[20rem] mx-auto app-card app-panel">
          {% if search_term %}
            <span class="text-xl font-semibold">No results found</span>
            <span class="text-sm">No audiobooks were found matching "{{ search_term }}". If the book doesn't exist on Audible it'll have to be added
              <a class="link" preload href="{{ base_url }}/search/manual">manually</a>.</span>
          {% else %}
            <span class="text-xl font-semibold">Perform a search</span>
            <span class="text-sm opacity-60">Nothing has been searched yet.</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock body %}
