{% extends "base.html" %}
{% block head %}
  <title>Search</title>
  <script>
  const onSearch = () => {
    const search_term = document.querySelector("input").value;
    document.getElementById("search").disabled = true;
    document.getElementById("search-text").style.display = "none";
    document.getElementById("search-spinner").style.display = "inline-block";
    window.location.href = `/search?q=${encodeURIComponent(search_term)}`;
  };
  const onPageChange = page => {
    const url = new URL(window.location);
    url.searchParams.set("page", page);
    window.location = url;
  };
  </script>
{% endblock head %}
{% block body %}
  <div class="w-screen flex flex-col items-center justify-center p-6 sm:p-8 overflow-x-hidden gap-6">
    <div class="w-full max-w-7xl">
      <div class="flex w-full justify-between items-center mb-8 gap-4">
        <div>
          <h1 class="text-4xl font-bold text-left">Search</h1>
          <p class="text-sm opacity-70 mt-1">Find audiobooks from Audible or add manually</p>
        </div>
        <a preload
           href="{{ base_url }}/search/manual"
           title="Manually add request"
           class="btn btn-primary btn-sm rounded-lg gap-2 flex items-center justify-center whitespace-nowrap">
          Manual Add
          {% include "icons/plus.html" %}
        </a>
      </div>

      <div class="flex flex-col gap-8 justify-start items-center w-full mb-12">
        <form class="flex items-center w-full max-w-3xl gap-2" onsubmit="onSearch();">
          <input name="q"
                 class="input focus:z-10 flex-1"
                 placeholder="Search by title, author, or narrator..."
                 {% if not search_term %}autofocus{% endif %}
                 value="{{ search_term }}"
                 spellcheck="false"
                 autocomplete="off"
                 list="search-suggestions"
                 hx-get="{{ base_url }}/search/suggestions?region={{ selected_region }}"
                 hx-target="#search-suggestions"
                 hx-swap="outerHTML"
                 hx-trigger="keyup changed delay:250ms" />
          {% block search_suggestions %}
            <datalist id="search-suggestions">
              {% for suggestion in (suggestions or [])[:3] %}<option value="{{ suggestion }}"></option>{% endfor %}
            </datalist>
          {% endblock search_suggestions %}
          <select class="select select-sm focus:z-10 max-w-24" name="region">
            {% for region in regions.keys() %}
              <option value="{{ region }}"
                      {% if region.__eq__(selected_region) %}selected="selected"{% endif %}>{{ region }}</option>
            {% endfor %}
          </select>
          <button id="search" class="btn btn-primary btn-sm" type="submit">
            <span id="search-text">Search</span>
            <span id="search-spinner" class="loading hidden"></span>
          </button>
        </form>

      {% block book_results %}
        <div id="book-results"
             class="w-full grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 pb-12">
          {% for result in search_results %}
            {% set book = result.book %}
            <div class="flex flex-col group">
                <div class="relative aspect-square rounded-lg overflow-hidden shadow-md border border-base-300 bg-base-300 group-hover:shadow-lg transition-shadow">
                    {% if book.cover_image %}
                      <img class="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500 ease-in-out"
                           src="{{ book.cover_image }}"
                           alt="{{ book.title }}" />
                    {% else %}
                      {% include "icons/photo-off.html" %}
                    {% endif %}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <!-- Hover Info Action -->
                    <div class="absolute bottom-2 right-2 flex gap-1 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all">
                         <a href="{{ base_url }}/book/{{ book.asin }}" class="btn btn-xs btn-primary btn-square rounded-lg shadow-lg flex items-center justify-center">
                            <span class="size-4">{% include "icons/info-circle.html" %}</span>
                         </a>
                    </div>

                    <!-- Request Button -->
                    <button class="absolute top-0 left-0 rounded-none rounded-br-lg btn-sm btn btn-square items-center justify-center flex {% if book.downloaded or result.already_requested %}btn-ghost bg-success text-success/20{% else %}btn-info{% endif %}"
                            hx-post="{{ base_url }}/search/request/{{ book.asin }}"
                            hx-disabled-elt="this"
                            hx-target="#book-results"
                            hx-include="this"
                            hx-swap="outerHTML"
                            hx-on:click="this.disabled = true;"
                            {% if book.downloaded or result.already_requested %}disabled{% endif %}>
                      <input type="hidden" name="query" value="{{ search_term }}" />
                      <input type="hidden" name="region" value="{{ selected_region }}" />
                      <input type="hidden" name="page" value="{{ page }}" />
                      <input type="hidden" name="search_term" value="{{ search_term }}" />
                      
                      {% if book.downloaded or result.already_requested %}
                        <span>{% include "icons/checkmark.html" %}</span>
                      {% else %}
                        {% if auto_start_download and user.can_download() %}
                          <span>{% include "icons/download.html" %}</span>
                        {% else %}
                          <span>{% include "icons/plus.html" %}</span>
                        {% endif %}
                      {% endif %}
                    </button>
                </div>

                <!-- Book Info -->
                <div class="pt-2 flex flex-col gap-1">
                    <a href="{{ base_url }}/book/{{ book.asin }}" 
                       class="text-xs text-primary font-bold hover:underline line-clamp-2" 
                       title="{{ book.title }}">
                        {{ book.title }}
                    </a>

                    {% if book.subtitle %}
                    <div class="opacity-60 font-semibold text-xs line-clamp-1" title="{{ book.subtitle }}">
                        {{ book.subtitle }}
                    </div>
                    {% endif %}

                    <div class="text-xs opacity-70 line-clamp-1" title="Authors: {{ book.authors | join(', ') }}">
                        {% for author in book.authors[:1] %}
                        <a href="{{ base_url }}/search?q={{ author }}" title="Search for {{ author }}" class="hover:underline">
                            {{ author }}
                        </a>
                        {% endfor %}
                        {% if book.authors | length > 1 %}
                        <span>+{{ book.authors | length - 1 }}</span>
                        {% endif %}
                    </div>

                    <!-- Runtime -->
                    <div class="text-xs opacity-60">
                        {{ (book.runtime_length_min / 60)|round(1) }}h
                    </div>
                </div>
            </div>
          {% endfor %}
        </div>
      {% endblock book_results %}

      {% if search_results or page > 0 %}
        <div class="flex justify-center mt-8">
            <div class="join">
              <button class="join-item btn"
                      onclick="onPageChange('{{ page-1 }}')"
                      {% if page.__eq__(0) %}disabled{% endif %}>«</button>
              <button class="join-item btn flex flex-col gap-0"
                      onclick="onPageChange('{{ 0 }}')"
                      {% if page.__eq__(0) %}disabled{% endif %}>
                Page {{ page+1 }}
                <span class="text-[0.5rem]">back to first</span>
              </button>
              <button class="join-item btn" onclick="onPageChange('{{ page+1 }}')">»</button>
            </div>
        </div>
      {% endif %}

      {% if not search_results %}
        <div class="pt-8 flex flex-col gap-1 items-center justify-center text-center max-w-[20rem] mx-auto">
          {% if search_term %}
            <span class="text-xl font-semibold">No results found</span>
            <span class="text-sm">No audiobooks were found matching "{{ search_term }}". If the book doesn't exist on Audible it'll have to be added
              <a class="link" preload href="{{ base_url }}/search/manual">manually</a>.</span>
          {% else %}
            <span class="text-xl font-semibold">Perform a search</span>
            <span class="text-sm opacity-60">Nothing has been searched yet.</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock body %}
